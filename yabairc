# Setup yabai scripting additions
# Only load scripting additions if not already loaded (avoids sudo prompts)
if ! yabai --check-sa 2>/dev/null; then
  yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
  echo "Run 'sudo yabai --load-sa' manually to enable scripting additions"
fi

# Set the number of spaces
DESIRED_SPACES=11

# Get current number of spaces
CURRENT_SPACES=$(yabai -m query --spaces | jq 'length' 2>/dev/null || echo 1)

# Create missing spaces if scripting additions are available
if [[ "$CURRENT_SPACES" -lt "$DESIRED_SPACES" ]]; then
  echo "Creating spaces: have $CURRENT_SPACES, need $DESIRED_SPACES"
  for ((i=$CURRENT_SPACES+1; i<=$DESIRED_SPACES; i++)); do
    if yabai -m space --create 2>/dev/null; then
      echo "Created space $i"
    else
      echo "Failed to create space $i (scripting additions may not be loaded)"
      break
    fi
  done
fi

# Function to setup a space (only if it exists)
function setup_space {
  local idx="$1"
  local name="$2"
  
  # Check if space exists before trying to configure it
  if yabai -m query --spaces --space "$idx" &>/dev/null; then
    echo "Configuring space $idx : $name"
    yabai -m space "$idx" --label "$name" 2>/dev/null || true
  else
    echo "Space $idx does not exist yet (will be named '$name' when created)"
  fi
}
setup_space 1 brave
setup_space 2 safari
setup_space 3 code
setup_space 4 xcode
setup_space 5 work
setup_space 6 communication
setup_space 7 music
setup_space 8 claude
setup_space 9 misc
setup_space 10 entertainment
setup_space 11 free

# Enable debug output
yabai -m config debug_output on

# Set the layout and padding
yabai -m config layout bsp
yabai -m config top_padding 0
yabai -m config bottom_padding 0
yabai -m config left_padding 0
yabai -m config right_padding 0
yabai -m config window_gap 0

# Setup all the rules
# brave
yabai -m rule --add app="Brave Browser" space=1
yabai -m rule --add app="Google Chrome" space=1
yabai -m rule --add app="Firefox" space=1

# safari
yabai -m rule --add app="Safari" space=2

# code
yabai -m rule --add app="Visual Studio Code" space=3
yabai -m rule --add app="iTerm2" space=3

# xcode
yabai -m rule --add app="Xcode" space=4
yabai -m rule --add app="Xcode-beta" space=4

# work
yabai -m rule --add app="Slack" space=5

# communication
yabai -m rule --add app="Messages" space=6
yabai -m rule --add app="Mail" space=6

# music
yabai -m rule --add app="Music" space=7

# claude
yabai -m rule --add app="Claude" space=8

# misc
yabai -m rule --add app="Finder" space=9

# entertainment
yabai -m rule --add app="Stremio" space=10

# free
yabai -m config --space 11 layout float
yabai -m rule --add app="App Store" space=11
yabai -m rule --add app="System Preferences" space=11
yabai -m rule --add app="Calendar" space=11
yabai -m rule --add app="System Preferences" space=11
yabai -m rule --add app="Activity Monitor" space=11
yabai -m rule --add app="Bitwarden" space=11
