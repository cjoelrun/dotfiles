# Setup yabai scripting additions
yabai -m signal --add event=dock_did_restart action="sudo yabai --load-sa"
sudo yabai --load-sa

# Set the number of spaces
DESIRED_SPACES=10
# Destroy all spaces greater than the desired spaces
# Skip if query fails
SPACES_JSON=$(yabai -m query --spaces 2>/dev/null)
if [[ -n "$SPACES_JSON" ]] && echo "$SPACES_JSON" | jq empty 2>/dev/null; then
  for idx in $(echo "$SPACES_JSON" | jq ".[].index | select(. > ${DESIRED_SPACES})" 2>/dev/null); do
    yabai -m space --destroy $idx 2>/dev/null
  done
fi

# Function to create a space
function setup_space {
  local idx="$1"
  local name="$2"
  local space=
  echo "setup space $idx : $name"

  space=$(yabai -m query --spaces --space "$idx" 2>/dev/null)
  if [ -z "$space" ] || [[ "$space" == "[" ]]; then
    yabai -m space --create 2>/dev/null
  fi

  yabai -m space "$idx" --label "$name" 2>/dev/null || true
}
setup_space 1 web
setup_space 2 code
setup_space 3 xcode
setup_space 4 work
setup_space 5 communication
setup_space 6 music
setup_space 7 claude
setup_space 8 misc
setup_space 9 entertainment
setup_space 10 free

# Set the layout and padding
yabai -m config layout bsp
yabai -m config top_padding 0
yabai -m config bottom_padding 0
yabai -m config left_padding 0
yabai -m config right_padding 0
yabai -m config window_gap 0

# Setup all the rules
# browser
yabai -m rule --add app="Safari" space=1
yabai -m rule --add app="Brave Browser" space=1
yabai -m rule --add app="Google Chrome" space=1
yabai -m rule --add app="Firefox" space=1

# code
yabai -m rule --add app="Visual Studio Code" space=2
yabai -m rule --add app="iTerm2" space=2

# xcode
yabai -m rule --add app="Xcode" space=3
yabai -m rule --add app="Xcode-beta" space=3

# work
yabai -m rule --add app="Slack" space=4

# communication
yabai -m rule --add app="Messages" space=5
yabai -m rule --add app="Mail" space=5

# music
yabai -m rule --add app="Music" space=6

# claude
yabai -m rule --add app="Claude" space=7

# misc
yabai -m rule --add app="Finder" space=8

# entertainment
yabai -m rule --add app="Stremio" space=9

# free
yabai -m config --space 10 layout float
yabai -m rule --add app="App Store" space=10
yabai -m rule --add app="System Preferences" space=10
yabai -m rule --add app="Calendar" space=10
yabai -m rule --add app="System Preferences" space=10
yabai -m rule --add app="Activity Monitor" space=10
yabai -m rule --add app="Bitwarden" space=10
